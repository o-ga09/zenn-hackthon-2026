# 要件定義書

## はじめに

AI旅行Vlog自動生成機能は、ユーザーがアップロードした旅行の写真・動画から、AIエージェントが自動的に魅力的な旅行Vlogを生成するWebアプリケーションの中核機能です。Firebase Genkit for GoとVertex AI (Gemini 3)、Veo3を活用して、高品質な動画コンテンツを自動生成します。

## 用語集

- **AIエージェント**: Firebase Genkit for Goで実装されるAI処理エンジン
- **Vlog**: Video Blog、動画形式のブログコンテンツ
- **Veo3**: Googleの動画生成AI
- **SSE**: Server-Sent Events、リアルタイム通信プロトコル
- **メディア**: ユーザーがアップロードした写真・動画ファイル
- **ストーリー**: Instagramストーリー形式のスライドショー動画
- **トークン**: API使用量を制限するための単位

## 要件

### 要件 1: AIエージェントによるVlog生成

**ユーザーストーリー:** 旅行者として、アップロードした写真・動画から自動的にVlogを生成してもらいたい、手動での動画編集作業を省略できるように。

#### 受入基準

1. WHEN ユーザーが複数の画像をアップロードしてVlog生成をリクエストした時、THE AIエージェント SHALL Firebase Genkit for Goを使用してVlog生成処理を開始する
2. WHEN AIエージェントが画像を分析する時、THE システム SHALL Gemini 3を使用して画像の内容、感情、ストーリーを理解する
3. WHEN AIエージェントがVlogを生成する時、THE システム SHALL Veo3を使用して動画またはスライドショーを生成する
4. WHEN Vlog生成が完了した時、THE システム SHALL 生成された動画をCloudflare R2ストレージに保存する
5. WHEN Vlog生成処理中にエラーが発生した時、THE システム SHALL 適切なエラーメッセージをユーザーに返す

### 要件 2: 非同期処理とリアルタイム通信

**ユーザーストーリー:** ユーザーとして、Vlog生成の進行状況をリアルタイムで確認したい、長時間の処理でも安心して待てるように。

#### 受入基準

1. WHEN ユーザーがVlog生成をリクエストした時、THE システム SHALL 即座にジョブIDを返して非同期処理を開始する
2. WHEN Vlog生成処理が進行中の時、THE システム SHALL SSEまたはWebSocketを使用してリアルタイムで進行状況を通知する
3. WHEN 処理状況が更新された時、THE システム SHALL 進行率、現在のステップ、推定残り時間を含む詳細情報を送信する
4. WHEN 処理が完了した時、THE システム SHALL 生成されたVlogのURLと詳細情報をクライアントに通知する
5. WHEN 処理がタイムアウトした時、THE システム SHALL 適切なタイムアウトエラーを返して処理を停止する

### 要件 3: メディア処理とストレージ管理

**ユーザーストーリー:** ユーザーとして、様々な形式の画像・動画をアップロードして、効率的に処理してもらいたい、ストレージ容量を気にせずに利用できるように。

#### 受入基準

1. WHEN ユーザーが画像をアップロードする時、THE システム SHALL JPEG、PNG、WebP形式をサポートする
2. WHEN ユーザーが動画をアップロードする時、THE システム SHALL MP4、MOV、AVI形式をサポートする
3. WHEN メディアファイルがアップロードされた時、THE システム SHALL ファイルサイズと形式を検証する
4. WHEN 生成されたVlogが保存される時、THE システム SHALL Cloudflare R2ストレージに適切なメタデータと共に保存する
5. WHEN ストレージ容量が上限に達した時、THE システム SHALL 古いファイルを自動的に削除するか、ユーザーに通知する

### 要件 4: ユーザー認証と権限管理

**ユーザーストーリー:** ユーザーとして、自分のVlogが安全に管理され、適切な権限でアクセスできるようにしたい、プライバシーが保護されるように。

#### 受入基準

1. WHEN 認証済みユーザーがVlog生成をリクエストする時、THE システム SHALL Firebase Authトークンを検証する
2. WHEN 未認証ユーザーが初回Vlog生成をリクエストする時、THE システム SHALL ブラウザセッションベースで1回のみ生成を許可する
3. WHEN 未認証ユーザーが2回目以降のVlog生成をリクエストする時、THE システム SHALL 認証を要求する
4. WHEN ユーザーが他人のVlogにアクセスしようとした時、THE システム SHALL 403 Forbiddenエラーを返す
5. WHEN ユーザーが自分のVlogを削除する時、THE システム SHALL 関連するすべてのファイルとメタデータを削除する
6. WHEN 管理者がシステムにアクセスする時、THE システム SHALL 管理者権限を適切に検証する

### 要件 5: パフォーマンスと可用性

**ユーザーストーリー:** ユーザーとして、Vlog生成が合理的な時間内に完了し、システムが安定して動作することを期待する、快適な体験を得られるように。

#### 受入基準

1. WHEN 5枚以下の画像でVlogを生成する時、THE システム SHALL 5分以内に処理を完了する
2. WHEN 10枚以下の画像でVlogを生成する時、THE システム SHALL 10分以内に処理を完了する
3. WHEN 同時に複数のVlog生成リクエストがある時、THE システム SHALL キューイングシステムで適切に処理する
4. WHEN システム負荷が高い時、THE システム SHALL 新しいリクエストを適切に制限する
5. WHEN APIエンドポイントが呼び出された時、THE システム SHALL 99%の可用性を維持する

### 要件 6: エラーハンドリングと監視

**ユーザーストーリー:** 開発者として、システムエラーを迅速に検出し、適切に対応できるようにしたい、サービス品質を維持するために。

#### 受入基準

1. WHEN AIエージェント処理でエラーが発生した時、THE システム SHALL 詳細なエラーログを記録する
2. WHEN 外部API（Vertex AI、Veo3）でエラーが発生した時、THE システム SHALL リトライ機能を実行する
3. WHEN 致命的なエラーが発生した時、THE システム SHALL 管理者に即座に通知する
4. WHEN ユーザーにエラーを返す時、THE システム SHALL セキュリティを考慮した適切なエラーメッセージを返す
5. WHEN システムメトリクスを収集する時、THE システム SHALL 処理時間、成功率、エラー率を記録する

### 要件 7: データ永続化と整合性

**ユーザーストーリー:** ユーザーとして、生成されたVlogとその関連情報が確実に保存され、いつでもアクセスできるようにしたい、データの損失を心配せずに利用できるように。

#### 受入基準

1. WHEN Vlog生成ジョブが開始された時、THE システム SHALL ジョブ情報をTiDBデータベースに記録する
2. WHEN Vlog生成が完了した時、THE システム SHALL 生成結果とメタデータをデータベースに保存する
3. WHEN データベース操作でエラーが発生した時、THE システム SHALL トランザクションをロールバックする
4. WHEN ファイルとデータベースの整合性が取れない時、THE システム SHALL 自動的に修復するか管理者に通知する
5. WHEN ユーザーがVlog履歴を要求した時、THE システム SHALL 正確な履歴情報を返す

### 要件 8: API設計とインターフェース

**ユーザーストーリー:** フロントエンド開発者として、明確で使いやすいAPIを通じてVlog生成機能を統合したい、効率的な開発ができるように。

#### 受入基準

1. WHEN `/api/agent/create-vlog` エンドポイントが呼び出された時、THE システム SHALL RESTful APIの原則に従ったレスポンスを返す
2. WHEN APIリクエストが送信された時、THE システム SHALL 適切なHTTPステータスコードを返す
3. WHEN APIレスポンスが返される時、THE システム SHALL 一貫したJSON形式を使用する
4. WHEN API仕様が変更された時、THE システム SHALL バージョニングを適切に管理する
5. WHEN APIドキュメントが必要な時、THE システム SHALL OpenAPI仕様に準拠したドキュメントを提供する
